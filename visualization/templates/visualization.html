<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visualization Page</title>
    <link
      href="{{ url_for('static', filename='css/visualization.min.css') }}"
      rel="stylesheet"
    />
    <link
      href="{{ url_for('static', filename='css/sweetalert-dark.css') }}"
      rel="stylesheet"
    />
    <link
      href="{{ url_for('static', filename='css/view_style.css') }}"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css"
    />

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        padding: 0;
        background: url("/static/images/maprova-bg.png") no-repeat center center
          fixed;
        background-size: cover;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
      }

      /* topbar styles */
      .topbar {
        background: linear-gradient(to right, #79ff7d, #04cf5c);
        margin: 0;
        position: fixed;
        width: 100%;
        text-align: center;
        padding: 20px 0rem;
        height: 55px;
        font-family: "Titillium Web", sans-serif;
        top: 0;
        left: 0;
        z-index: 10;
      }

      .topbar img {
        width: 150px;
        height: auto;
      }

      /* Icon container on the left */
      .icon-container {
        display: flex;
        gap: 15px;
        margin-left: 20px;
      }

      /* Styling for individual icons */
      .icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 35px;
        height: 35px;
      }

      /* Center the logo */
      .topbar img {
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <div
      class="topbar shadow-lg d-flex justify-content-between align-items-center mb-5"
    >
      <!-- Icon container on the left -->
      <div class="icon-container d-flex gap-2">
        <div id="usbIcon" class="icon" title="USB Status">
          <!-- Inline SVG for USB icon -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            width="18"
            height="18"
            fill="white"
          >
            <path
              d="M15,7V11H16V13H13V5H15L12,1L9,5H11V13H8V10.93C8.7,10.56 9.2,9.85 9.2,9C9.2,7.78 8.21,6.8 7,6.8C5.78,6.8 4.8,7.78 4.8,9C4.8,9.85 5.3,10.56 6,10.93V13A2,2 0 0,0 8,15H11V18.05C10.29,18.41 9.8,19.15 9.8,20A2.2,2.2 0 0,0 12,22.2A2.2,2.2 0 0,0 14.2,20C14.2,19.15 13.71,18.41 13,18.05V15H16A2,2 0 0,0 18,13V11H19V7H15Z"
            />
          </svg>
        </div>

        <div id="wifiIcon" class="icon" title="WiFi Status">
          <!-- Inline SVG for WiFi icon -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            width="18"
            height="18"
            fill="white"
          >
            <path
              d="M12,21L15.6,16.2C14.6,15.45 13.35,15 12,15C10.65,15 9.4,15.45 8.4,16.2L12,21M12,3C7.95,3 4.21,4.34 1.2,6.6L3,9C5.5,7.12 8.62,6 12,6C15.38,6 18.5,7.12 21,9L22.8,6.6C19.79,4.34 16.05,3 12,3M12,9C9.3,9 6.81,9.89 4.8,11.4L6.6,13.8C8.1,12.67 9.97,12 12,12C14.03,12 15.9,12.67 17.4,13.8L19.2,11.4C17.19,9.89 14.7,9 12,9Z"
            />
          </svg>
        </div>

        <div id="serverIcon" class="icon" title="Server Status">
          <!-- Inline SVG for Server icon -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            width="18"
            height="18"
            fill="white"
          >
            <path
              d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"
            />
          </svg>
        </div>
      </div>

      <!-- Centered logo -->
      <a class="flex-grow-1 text-center">
        <img
          src="{{ url_for('static', filename='images/dark-logo.png') }}"
          alt="Logo"
          style="max-width: 100%; height: auto"
        />
      </a>
    </div>
    <script>
      // Function to set USB icon color
      function setUsbIconColor(color) {
        document.querySelector("#usbIcon svg").style.fill = color;
      }

      // Function to set WiFi icon color
      function setWifiIconColor(color) {
        document.querySelector("#wifiIcon svg").style.fill = color;
      }

      // Function to set Server icon color
      function setServerIconColor(color) {
        document.querySelector("#serverIcon svg").style.fill = color;
      }

      // Example usage: set the color to either #f94f5f or limegreen
      setUsbIconColor("#f94f5f"); // Set USB icon to red
      setWifiIconColor("limegreen"); // Set WiFi icon to limegreen
      setServerIconColor("#f94f5f"); // Set Server icon to red
    </script>

    <div id="visualizations" class="mt-5">
      <div id="vizcon1"></div>
      <div id="vizcon2"></div>
      <div id="vizcon3"></div>
    </div>

    <div id="breakingNewsBar" class="breaking-news-bar">
      <div class="news-icon-container">
        <div
          class="news-icon d-flex align-items-center justify-content-center fw-bolder"
          id="newsIcon"
        ></div>
      </div>
      <div class="news-content-container">
        <div class="news-time fw-bold" id="newsTime"></div>
        <div id="systemInfo"></div>
        <div class="update-time fw-bold" id="updateTimer">
          Opdaterer om 60 sekunder
        </div>
      </div>
      <div class="news-content fw-bold" id="newsContent"></div>
    </div>

    <script src="{{ url_for('static', filename='js/view_script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/socket.io.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sweetalert.js') }}"></script>

    <script>
      var socket = io.connect("http://127.0.0.1:5000");

      document.addEventListener("DOMContentLoaded", function () {
        let messageQueue = [];
        let displayTimeout;

        const newsIcon = document.getElementById("newsIcon");
        const newsContent = document.getElementById("newsContent");
        const newsTime = document.getElementById("newsTime");
        const breakingNewsBar = document.getElementById("breakingNewsBar");

        // Estimate the maximum number of characters that can fit in the message display area
        function estimateMaxChars(sampleText, fontSize, fontFamily) {
          const containerWidth = window.innerWidth - 200;
          const span = document.createElement("span");
          document.body.appendChild(span);
          span.style.fontSize = fontSize;
          span.style.fontFamily = fontFamily;
          span.style.visibility = "hidden";
          span.textContent = sampleText;
          const sampleTextWidth = span.offsetWidth;
          const maxChars = Math.floor(
            (containerWidth / sampleTextWidth) * sampleText.length
          );
          document.body.removeChild(span);
          return maxChars;
        }

        const maxMessageLength = estimateMaxChars(
          "Sample Text",
          "60px",
          "Arial"
        );

        function updateDateTime() {
          const now = new Date();
          const options = {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          };
          let formattedDate = now.toLocaleDateString("da-DK", options);
          const formattedTime = now.toLocaleTimeString("da-DK", {
            hour: "2-digit",
            minute: "2-digit",
          });
          formattedDate =
            formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1);
          newsTime.textContent = `${formattedDate} - ${formattedTime}`;
        }

        function splitMessage(message, color, icon) {
          let parts = [];
          while (message.length > 0) {
            let end = Math.min(message.length, maxMessageLength);
            // Adjust the end index to avoid splitting in the middle of a word
            end =
              end < message.length && message[end] !== " "
                ? message.lastIndexOf(" ", end) + 1
                : end;
            let part = message.slice(0, end).trim();
            // Include the icon along with each message part
            parts.push({
              icon: icon,
              message: part + (end < message.length ? " ..." : ""),
              color: color,
            });
            message = message.slice(end);
          }
          return parts;
        }

        function prepareMessages(messages) {
          messages.forEach((item) => {
            if (item.message.length > maxMessageLength) {
              // Pass the icon along with the message and color
              splitMessage(item.message, item.color, item.icon).forEach(
                (part) => messageQueue.push(part)
              );
            } else {
              messageQueue.push(item);
            }
          });
        }

        function showMessage() {
          if (messageQueue.length === 0) {
            return;
          }

          const { icon, message, color } = messageQueue.shift();
          newsIcon.innerHTML = `<span class="mdi mdi-${icon}"></span>`;
          newsContent.textContent = message;
          newsIcon.style.backgroundColor = color;
          breakingNewsBar.style.backgroundColor = color;

          breakingNewsBar.style.bottom = "0px";
          newsIcon.style.opacity = "1";
          newsTime.style.paddingLeft = "125px";

          if (messageQueue.length === 0) {
            setTimeout(() => {
              breakingNewsBar.style.bottom = "-100px";
              newsIcon.style.opacity = "0";
              newsTime.style.paddingLeft = "15px";
              displayTimeout = setTimeout(loadData, 10000); // Restart the cycle
            }, 5000);
          } else {
            displayTimeout = setTimeout(showMessage, 7000); // Show the next message
          }
        }

        function loadData() {
          fetch("http://127.0.0.1:5000/api/get_messages")
            .then((res) => res.json())
            .then((data) => {
              const messages = data.map((item) => ({
                icon: item.message_icon,
                message: item.message_text,
                color: item.message_color,
              }));
              prepareMessages(messages);
              showMessage(); // Start showing messages after preparation
            })
            .catch((err) => console.error(err));
        }

        loadData();
        setInterval(updateDateTime, 1000);
      });

      // Define a SweetAlert mixin with your desired settings
      const toast = Swal.mixin({
        toast: true,
        position: "bottom-start",
        background: "#343a40", // Dark color
        color: "#ffffff", // White text color
        showConfirmButton: false, // No buttons
        timer: false, // No auto timer
        showCloseButton: false, // No close button
        allowOutsideClick: false,
        allowEscapeKey: false,
      });

      // Trigger SweetAlert when the socket disconnects
      socket.on("disconnect", function () {
        toast.fire({
          title: "Advarsel",
          text: "Forbindelsen til serveren er afbrudt. Genindl√¶s siden.",
          icon: "warning",
        });
      });

      // Remove the alert when the socket connection is reinstated
      socket.on("connect", function () {
        Swal.close(); // This will close any active alert
        Swal.mixin({
          toast: true,
          position: "bottom-start",
          background: "#343a40", // Dark color
          color: "#ffffff", // White text color
          showConfirmButton: false, // No buttons
          timer: false, // No auto timer
          showCloseButton: false, // No close button
          allowOutsideClick: false,
          allowEscapeKey: false,
          title: "Success",
          icon: "success",
          text: "Forbindelsen til serveren er genoprettet.",
        });
      });
    </script>
  </body>
</html>
