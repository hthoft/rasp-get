<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Website</title>
    <!-- Link Bootstrap CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <style>
      /* Remove margin and padding from body */
      body {
        margin: 0;
        padding: 0;
      }
      #splashContainer {
        position: relative;
        display: inline-block;
      }
      #overlayText {
        position: absolute;
        top: 75%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 3rem;
        font-weight: bold;
        z-index: 2;
      }
      #nextContainer,
      #printQRContainer,
      #vaegQRContainer,
      #settingsContainer {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 800px;
        height: 480px;
        background-image: url("maprova-bg.png");
        background-size: cover;
        background-position: center;
        text-align: center;
        padding-top: 20px;
        z-index: 1; /* Ensure it appears above other elements */
      }
      #buttonContainer {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 20px;
      }

      #buttonContainer2 {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        flex-wrap: nowrap;
      }
      .btn-large {
        width: 300px;
        height: 200px;
        font-size: 1.5rem;
      }
      #settingsIcon {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 50px;
        height: 50px;
        cursor: pointer;
      }
      h2,
      h1 {
        margin: 10px 0;
        color: white;
      }

      /* Fullscreen scrollable list container */
      .list-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 800px;
        height: 480px;
        background-color: rgba(255, 255, 255, 0.95);
        z-index: 10;
        overflow-y: scroll;
        padding: 20px;
      }

      .list-item {
        font-size: 1.8rem;
        padding: 15px;
        border-bottom: 1px solid #ccc;
        cursor: pointer;
      }

      .list-item:hover {
        background-color: #f0f0f0;
      }

      h2,
      h1 {
        margin: 10px 0;
        color: white;
      }

      /* Disable Vælg Job button when no project is selected */
      #selectJobBtn:disabled {
        background-color: #cccccc;
        border-color: #cccccc;
      }

      /* Styles for the title displaying selected project and job */
      .selected-entity {
        margin-top: 20px;
        font-weight: bold;
        color: white;
      }
    </style>
  </head>
  <body>
    <div id="splashContainer">
      <a id="splashLink" href="#">
        <img
          id="splashImage"
          src="splash.png"
          alt="Splash Image"
          width="800"
          height="480"
        />
        <div id="overlayText">START</div>
      </a>
    </div>

    <div id="nextContainer">
      <img id="settingsIcon" src="cog.png" alt="Settings" />
      <img
        src="dark-logo.png"
        alt="MAPROVA Logo"
        class="mt-5"
        width="250"
        style="filter: invert(1)"
      />

      <div id="buttonContainer">
        <button
          type="button"
          id="printQR"
          class="btn btn-danger btn-large fs-1 fw-bolder shadow"
          style="
            border-radius: 1.5rem;
            background-color: #04cf5c;
            border-color: #04cf5c;
          "
        >
          Print QR
        </button>
        <button
          type="button"
          id="selectQR"
          class="btn btn-light btn-large fs-1 fw-bolder shadow"
          style="border-radius: 1.5rem"
        >
          Vælg QR
        </button>
      </div>
      <div id="selectedEntity">
        <h2 class="mt-4 fw-light">Vælg projekt</h2>
        <h1 class="fw-bolder">...</h1>
      </div>
    </div>

    <div id="printQRContainer" style="display: none">
      <div
        id="countContainer"
        class="d-flex justify-content-center align-items-center"
        style="margin-top: 1.2rem"
      >
        <button id="minusBtn" class="btn btn-lg btn-light px-5 py-3 shadow">
          <img src="qrcode-remove.svg" alt="Minus" width="100" height="100" />
        </button>
        <div
          id="countDisplay"
          class="form-control text-center mx-4 fw-bold shadow"
          style="width: 110px; font-size: 80px; pointer-events: none"
        >
          1
        </div>
        <button id="plusBtn" class="btn btn-lg btn-light px-5 py-3 shadow">
          <img src="qrcode-plus.svg" alt="Plus" width="100" height="100" />
        </button>
      </div>

      <div id="actionButtons" class="mt-3 text-center">
        <button
          id="cancelBtn"
          class="btn btn-danger btn-lg mx-2 fw-bolder text-black shadow"
        >
          <img
            src="printer-pos-cancel-outline.svg"
            alt="Plus"
            width="100"
            height="100"
          /><br />
          Afbryd
        </button>
        <button
          id="printBtn"
          class="btn btn-lg mx-2 fw-bolder text-black shadow w-50"
          style="background-color: #04cf5c"
        >
          <img
            src="printer-pos-check-outline.svg"
            alt="Plus"
            width="100"
            height="100"
          /><br />
          Print QR
        </button>
      </div>
      <span
        class="mt-4 fw-light mb-0 badge fs-2"
        id="printProjectEntity"
      ></span>
      <h1 class="fw-bolder" id="printJobEntity"></h1>
    </div>

    <div id="vaegQRContainer">
      <div class="mt-5">
        <!-- Button to cancel -->
        <button
          id="cancelJobBtn"
          class="btn btn-light btn-lg fw-bolder shadow p-2 px-4 border-0 mb-1"
          style="border-radius: 1rem; background-color: lightcoral"
        >
          <i class="mdi mdi-cancel"></i> Gå tilbage
        </button>
      </div>

      <div id="buttonContainer" class="row">
        <button
          type="button"
          id="selectProjectBtn"
          class="btn btn-large btn-light fs-1 fw-bolder shadow"
          style="border-radius: 1.5rem"
        >
          Vælg Sag
        </button>
        <button
          type="button"
          id="selectJobBtn"
          class="btn btn-large btn-light fs-1 fw-bolder shadow"
          style="border-radius: 1.5rem"
          disabled
        >
          Vælg Job
        </button>
      </div>

      <span class="badge fs-2 fw-light mb-0 mt-4" id="projectEntity">
        Vælg projekt
      </span>

      <h1 class="fw-bolder" id="jobEntity">Vælg QR Code</h1>
    </div>

    <div id="projectListContainer" class="list-container">
      <h3 class="text-center mb-4">Vælg Projekt</h3>
      <div id="projectList"></div>
    </div>

    <!-- Scrollable List for Jobs -->
    <div id="jobListContainer" class="list-container">
      <h3 class="text-center mb-4">Vælg Job</h3>
      <div id="jobList"></div>
    </div>

    <div id="settingsContainer" style="display: none">
      <h1>Indstillinger Window</h1>
    </div>

    <!-- Optional: Include Bootstrap JS and jQuery -->
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.6.0.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const splashLink = document.getElementById("splashLink");
        const splashImage = document.getElementById("splashImage");
        const overlayText = document.getElementById("overlayText");
        const splashContainer = document.getElementById("splashContainer");
        const nextContainer = document.getElementById("nextContainer");
        const printQRContainer = document.getElementById("printQRContainer");
        const vaegQRContainer = document.getElementById("vaegQRContainer");
        const settingsContainer = document.getElementById("settingsContainer");

        const selectProjectBtn = document.getElementById("selectProjectBtn");
        const selectJobBtn = document.getElementById("selectJobBtn");
        const projectListContainer = document.getElementById(
          "projectListContainer"
        );
        const projectList = document.getElementById("projectList");
        const jobListContainer = document.getElementById("jobListContainer");
        const jobList = document.getElementById("jobList");
        const projectEntity = document.getElementById("projectEntity");
        const jobEntity = document.getElementById("jobEntity");
        const selectedEntity = document.getElementById("selectedEntity");

        const printProjectEntity =
          document.getElementById("printProjectEntity");
        const printJobEntity = document.getElementById("printJobEntity");

        let projectsData = null;
        let jobsData = {};

        let selectedProject = null;
        let selectedJob = null;

        let countdownTimer;
        const countdownTime = 110000; // 10 seconds in milliseconds

        function resetTimer() {
          clearTimeout(countdownTimer);
          countdownTimer = setTimeout(function () {
            nextContainer.style.display = "none";
            printQRContainer.style.display = "none";
            vaegQRContainer.style.display = "none";
            settingsContainer.style.display = "none";
            splashContainer.style.display = "block";
            projectListContainer.style.display = "none";
            jobListContainer.style.display = "none";

            splashImage.style.display = "block";
            overlayText.style.display = "block";
          }, countdownTime);
        }

        splashLink.addEventListener("click", function (event) {
          event.preventDefault();
          splashImage.style.display = "none";
          overlayText.style.display = "none";
          nextContainer.style.display = "block";
          resetTimer();
        });

        document
          .querySelector("#printQR")
          .addEventListener("click", function () {
            printQRContainer.style.display = "block";
            nextContainer.style.display = "none";
            resetTimer();

            let count = 1;
            updateCountDisplay();

            document
              .getElementById("plusBtn")
              .addEventListener("click", function () {
                if (count < 5) {
                  count++;
                  updateCountDisplay();
                }
              });

            document
              .getElementById("minusBtn")
              .addEventListener("click", function () {
                if (count > 1) {
                  count--;
                  updateCountDisplay();
                }
              });

            function updateCountDisplay() {
              document.getElementById("countDisplay").textContent = count;
              resetTimer();
            }

            document
              .getElementById("cancelBtn")
              .addEventListener("click", function () {
                printQRContainer.style.display = "none";
                nextContainer.style.display = "block";
                resetTimer();
              });
          });

        document
          .getElementById("printBtn")
          .addEventListener("click", function () {
            selectedPrintJob = localStorage.getItem("selectedEntity");
            console.log(
              "Printing QR " +
                document.getElementById("countDisplay").textContent +
                " times..."
            );
            console.log(selectedPrintJob);
            printQRContainer.style.display = "none";
            nextContainer.style.display = "block";
            resetTimer();
          });

        document
          .querySelector("#selectQR")
          .addEventListener("click", function () {
            vaegQRContainer.style.display = "block";
            nextContainer.style.display = "none";
            resetTimer();
            fetchAllProjectsAndJobs(); // Fetch projects and jobs when splashContainer is clicked
          });

        document
          .getElementById("settingsIcon")
          .addEventListener("click", function () {
            settingsContainer.style.display = "block";
            nextContainer.style.display = "none";
            resetTimer();
          });

        document
          .getElementById("cancelJobBtn")
          .addEventListener("click", function () {
            vaegQRContainer.style.display = "none";
            nextContainer.style.display = "block";
            resetTimer();
          });

        // Fetch projects and jobs data on splash click
        function fetchAllProjectsAndJobs() {
          if (projectsData && Object.keys(jobsData).length > 0) {
            console.log("Using cached project and job data.");
            return;
          }

          console.log("Fetching project and job data...");

          // Fetch all projects
          $.ajax({
            url: "http://127.0.0.1:5000/api/projects", // Replace with actual API URL
            type: "GET",
            dataType: "json",
            success: function (projects) {
              projectsData = projects;
              localStorage.setItem(
                "projectsData",
                JSON.stringify(projectsData)
              );

              projects.forEach((project) => {
                fetchJobsForProject(project.id);
              });
            },
            error: function (xhr, status, error) {
              console.error("Error fetching projects:", error);
            },
          });
        }

        // Fetch jobs for a given project and store them
        function fetchJobsForProject(projectId) {
          $.ajax({
            url: `http://127.0.0.1:5000/api/jobs/${projectId}`, // Replace with actual API URL
            type: "GET",
            dataType: "json",
            success: function (jobs) {
              jobsData[projectId] = jobs;
              localStorage.setItem("jobsData", JSON.stringify(jobsData));
            },
            error: function (xhr, status, error) {
              console.error(
                "Error fetching jobs for project:",
                projectId,
                error
              );
            },
          });
        }

        // Display the pre-fetched projects in a scrollable list
        function displayProjects() {
          projectList.innerHTML = ""; // Clear any previous list
          if (projectsData && projectsData.length > 0) {
            projectsData.forEach((project) => {
              // Create a button for each project
              const projectItem = document.createElement("button");
              projectItem.classList.add(
                "list-item",
                "btn",
                "btn-light",
                "my-2",
                "w-100"
              );

              // Set data attributes for the project id and title
              projectItem.setAttribute("data-project-id", project.id);
              projectItem.setAttribute(
                "data-project-title",
                project.project_title
              );

              projectItem.textContent = `${project.project_id} - ${project.project_title}`;

              // Add both click and touchstart events
              projectItem.addEventListener("click", handleProjectSelection);
              projectItem.addEventListener(
                "touchstart",
                handleProjectSelection
              );

              projectList.appendChild(projectItem);
            });
          } else {
            console.log("No projects found or data not loaded yet.");
          }
        }

        // Handle project selection when clicked or touched
        function handleProjectSelection(event) {
          event.preventDefault();
          event.stopPropagation();
          alert("Project selected");
          const projectId = this.dataset.projectId;
          const projectTitle = this.dataset.projectTitle;

          projectListContainer.style.display = "none"; // Hide the job list when a new project is selected

          // Find the selected project in the projectsData array
          selectedProject = projectsData.find(
            (project) => project.id == projectId
          ); // Use non-strict comparison for flexibility
          localStorage.setItem(
            "selectedProject",
            JSON.stringify(selectedProject)
          );

          updateSelectedEntity();

          // Clear the selected job when a new project is selected
          selectedJob = null;
          jobEntity.textContent = "Vælg Job"; // Reset job display

          projectListContainer.style.display = "none";
          projectEntity.textContent = selectedProject.project_title;
          projectEntity.style.backgroundColor =
            selectedProject.project_color || "#ffffff"; // Fallback to a default color

          selectJobBtn.disabled = false; // Enable the job button

          // Display pre-fetched jobs for the selected project
          displayJobsForProject(selectedProject.id);
        }

        // Display jobs for the selected project
        function displayJobsForProject(projectId) {
          jobList.innerHTML = ""; // Clear previous job list
          if (jobsData[projectId] && jobsData[projectId].length > 0) {
            jobsData[projectId].forEach((job) => {
              // Create a button for each job
              const jobItem = document.createElement("button");
              jobItem.classList.add(
                "list-item",
                "btn",
                "btn-light",
                "my-2",
                "w-100"
              );

              // Set data attributes for the job id and title
              jobItem.setAttribute("data-job-id", job.id);
              jobItem.setAttribute("data-job-title", job.job_title);

              jobItem.textContent = job.job_title;

              // Add both click and touchstart events
              jobItem.addEventListener("click", handleJobSelection);
              jobItem.addEventListener("touchstart", handleJobSelection);

              jobList.appendChild(jobItem);
            });
          } else {
            console.log(
              "No jobs found for this project or data not loaded yet."
            );
            jobListContainer.style.display = "none";
          }
        }

        // Handle job selection when clicked or touched
        function handleJobSelection() {
          const jobId = this.dataset.jobId;
          const jobTitle = this.dataset.jobTitle;

          selectedJob = jobsData[selectedProject.id].find(
            (job) => job.id == jobId // Ensure comparison is not strict as types might vary
          );

          if (selectedJob) {
            localStorage.setItem(
              "selectedEntity",
              JSON.stringify({
                project: selectedProject,
                job: selectedJob,
              })
            );
            jobListContainer.style.display = "none";
            jobEntity.textContent = selectedJob.job_title;
            updateSelectedEntity();
          } else {
            console.error("Job not found!");
          }
        }

        // Update the display to show the selected project and job
        function updateSelectedEntity() {
          const entity =
            JSON.parse(localStorage.getItem("selectedEntity")) || {};
          const projectTitle =
            entity.project?.project_title || "Ingen projekt valgt";
          const jobTitle = entity.job?.job_title || "Ingen job valgt";
          const projectColor = entity.project?.project_color || "grey";
          selectedEntity.innerHTML = `
      <h2 class="badge mt-4 fs-2 mb-0 fw-light" style="background-color: ${projectColor}">${projectTitle}</h2>
      <h1 class="fw-bolder">${jobTitle}</h1>
    `;
          projectEntity.textContent = projectTitle;
          projectEntity.style.backgroundColor =
            entity.project?.project_color || "grey";
          jobEntity.textContent = jobTitle;
          printProjectEntity.textContent = projectTitle;
          printJobEntity.textContent = jobTitle;
          printProjectEntity.style.backgroundColor = projectColor;
        }

        // Event listener for the project button
        selectProjectBtn.addEventListener("click", function () {
          projectListContainer.style.display = "block";
          displayProjects(); // Use pre-fetched projects to display
          resetTimer();
        });

        // Event listener for the job button
        selectJobBtn.addEventListener("click", function () {
          if (selectedProject) {
            jobListContainer.style.display = "block";
            displayJobsForProject(selectedProject.id); // Use pre-fetched jobs to display
            resetTimer();
          }
        });

        // Initialize selected project and job if already in localStorage
        updateSelectedEntity();
      });
    </script>
  </body>
</html>
