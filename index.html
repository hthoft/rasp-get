<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=800, height=480">
    <title>Event Stats</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: black;
            display: flex;
            flex-wrap: wrap;
            width: 800px;
            height: 480px;
        }
        .block {
            width: 400px;
            height: 240px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-family: Arial, sans-serif;
        }
        #billetter {
            color: #FF5733; /* Vibrant red */
        }
        #medlemsskaber {
            color: #33FF57; /* Vibrant green */
        }
        #tutorer {
            color: #3357FF; /* Vibrant blue */
        }
        #total {
            color: #FF33A8; /* Vibrant pink */
        }
        h1 {
            margin: 0;
            font-size: 4rem;
        }
        p {
            margin: 10px 0 0;
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <div id="billetter" class="block">
        <h1 id="billetterCount">0</h1>
        <p>Billetter</p>
    </div>
    <div id="medlemsskaber" class="block">
        <h1 id="medlemsskaberCount">0</h1>
        <p>Medlemsskaber</p>
    </div>
    <div id="tutorer" class="block">
        <h1 id="tutorerCount">0</h1>
        <p>Tutorer</p>
    </div>
    <div id="total" class="block">
        <h1 id="totalCount">0</h1>
        <p>Total</p>
    </div>

    <script>
        function generateHash(string) {
            return crypto.subtle.digest('SHA-256', new TextEncoder().encode(string)).then(hashBuffer => {
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex;
            });
        }

        async function getEventData(eventUrl) {
    try {
        const proxyUrl = 'https://api.allorigins.win/get?url=';
        const encodedUrl = encodeURIComponent(eventUrl);
        const response = await fetch(proxyUrl + encodedUrl);
        const data = await response.json();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(data.contents, "text/xml");

        if (xmlDoc.getElementsByTagName('error').length > 0) {
            return 0; // invalid event id or XML error
        }

        let totalCount = 0;
        const tickets = xmlDoc.getElementsByTagName("ticket");
        for (const ticket of tickets) {
            const prices = ticket.getElementsByTagName("price");
            for (const price of prices) {
                totalCount += parseInt(price.getElementsByTagName("count")[0].textContent);
            }
        }
        return totalCount;
    } catch (error) {
        console.error("Error fetching event data:", error);
        return 0;
    }
}

async function fetchEventStats() {
    const eventIds = ["100534", "100541", "100963"];
    const totalTickets = 6000;
    let totalCount = 0;

    const host = "https://studentersamfundet.safeticket.dk/api/";
    const params = {
        version: 1,
        user: "ssf_sales",
        secret: "91a03fad61159e49c99f63dc944ab04d36c5640a5354ef4266b2d39329d25fd3",
        cash: 1
    };
    const endpoints = "stats/";

    const counts = await Promise.all(eventIds.map(async (eventId) => {
        const hashString = `${params.version}:${params.user}:${eventId}:${params.cash}:${params.secret}`;
        const hash = await generateHash(hashString);
        const url = `${host}${endpoints}${eventId}?version=${params.version}&user=${params.user}&cash=${params.cash}&event=${eventId}&sha=${hash}`;
        const count = await getEventData(url);
        totalCount += count;
        return count;
    }));

    document.getElementById('billetterCount').textContent = counts[0];
    document.getElementById('medlemsskaberCount').textContent = counts[1];
    document.getElementById('tutorerCount').textContent = counts[2];
    document.getElementById('totalCount').textContent = totalCount;

    console.log(`Total sold: ${(totalCount / totalTickets) * 100}%`);
}

fetchEventStats();
setInterval(fetchEventStats, 60000); // Update every minute

    </script>
</body>
</html>
